<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Apartment Booking</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 20px;
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 20px;
      }

      .day {
        padding: 10px;
        border: 1px solid #ccc;
        cursor: pointer;
        border-radius: 6px;
      }

      .booked {
        background-color: #f44336;
        color: white;
        pointer-events: none;
      }

      .available {
        background-color: #4caf50;
        color: white;
      }

      .selected {
        background-color: #2196f3 !important;
        color: white;
      }

      button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        background-color: #333;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>Apartment Booking Calendar</h2>
    <div id="calendarContainer"></div>
    <button onclick="submitBooking()">Submit Booking</button>

    <script>
      const a_id = new URLSearchParams(window.location.search).get("a_id");
      const DEPLOY_ID = "AKfycbwM72sTLcRVl_koHp_B1tm90wGgQR8ZMuhlteCpQ3JFDn3SQETh3d78js40xICSIWuE";
      const BASE = `https://script.google.com/macros/s/${DEPLOY_ID}/exec`;

      let bookedDates = [];
      let selectedDates = [];

      async function fetchBookings() {
        const url = `${BASE}?a_id=${a_id}&action=getBookings`;
        const res = await fetch(url);
        const data = await res.json();
        bookedDates = data.map(ev => ev.start.split("T")[0]);
        renderCalendar();
      }

      function renderCalendar(monthOffset = 0) {
        const container = document.getElementById("calendarContainer");
        container.innerHTML = "";

        const today = new Date();
        today.setMonth(today.getMonth() + monthOffset);
        const year = today.getFullYear();
        const month = today.getMonth();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        const calendar = document.createElement("div");
        calendar.className = "calendar";

        const daysInMonth = lastDay.getDate();
        const startDay = firstDay.getDay();

        for (let i = 0; i < startDay; i++) {
          const empty = document.createElement("div");
          calendar.appendChild(empty);
        }

        for (let i = 1; i <= daysInMonth; i++) {
          const date = new Date(year, month, i);
          const dateStr = date.toISOString().split("T")[0];

          const cell = document.createElement("div");
          cell.className = "day";
          cell.textContent = i;

          if (bookedDates.includes(dateStr)) {
            cell.classList.add("booked");
          } else {
            cell.classList.add("available");
            cell.onclick = () => toggleDate(dateStr, cell);
          }

          calendar.appendChild(cell);
        }

        container.appendChild(calendar);
      }

      function toggleDate(dateStr, element) {
        if (selectedDates.includes(dateStr)) {
          selectedDates = selectedDates.filter(d => d !== dateStr);
          element.classList.remove("selected");
        } else {
          selectedDates.push(dateStr);
          element.classList.add("selected");
        }
      }

      async function submitBooking() {
        if (selectedDates.length === 0) {
          alert("Please select at least one date.");
          return;
        }

        const start = selectedDates[0];
        const end = selectedDates[selectedDates.length - 1];

        const url = `${BASE}?a_id=${a_id}&action=addBooking&start=${start}&end=${end}`;
        const res = await fetch(url);
        const result = await res.text();

        alert(result || "Booking submitted!");
        selectedDates = [];
        fetchBookings(); // Reload calendar
      }

      fetchBookings();
    </script>
  </body>
</html>
